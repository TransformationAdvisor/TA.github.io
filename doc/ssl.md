---
layout: page
title: TA Documentation
---

For Liberty applications deployed through TA, when Ingress is enabled, Ingress generates a self-signed certificate and key pair that is used to access the application externally via https. 

It is possible to configure Ingress to use your own CA certificate and key pair using these steps:
1. Encode your key and cert using base64:
```cat my.key | base64```

2. Create a Secret that contains a CA certificate and key pair in the same namespace as your deployment:
```
apiVersion: v1
kind: Secret
metadata:
  name: ta-tls-ca-key-pair
  namespace: default
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNxRENDQVpBQ0NRRFV3azBsU1BjRGdUQU5CZ2txaGtpRzl3MEJBUXNGQURBV01SUXdFZ1lEVlFRRERBczUKTGpReUxqSTVMakV3TXpBZUZ3MHhPVEF6TVRNeE5UTTFNRFphRncwME5qQTNNamt4TlRNMU1EWmFNQll4RkRBUwpCZ05WQkFNTUN6a3VOREl1TWprdU1UQXpNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDCkFRRUF2L1lvVTJKeU9rNWloV1NsOVMzRllyMzBkbjhObGRJMGRwN2hkSUtlZUJiOWZjT1BJS09Rd0t3UjdCcmwKSXgxSVpqdG1sTmVTSndaNnJ2d1dhdk5GU09iUHhxR2Qwbk5ncUViWkZtT2cvY0h4MUlreTRrT0hib3VyZ0VTMQozdDFYTU0xWUFmNVJtU1E0TkJvZUxBR1lVQWhoMzlpMUp2OWxuR0RXT0ozbGh5L0c4NHgxLzhMYitDUUc3RUI3CmlxNkxrZGg5OHZ6Y0xIYXZWS2FiWnZJeDFyVnR0VUlMS0xCVytwU3l4N2lkVkVhVlczVkZXa202YloxeTR6S0QKQ3hHd21DWHdKREJjYnBSTVhzZkJhYUQ1YUk4eCtoOTYyMlRmRGNQVDJKS2VRMjB2L3BDUjREQ2xvOUZ6L1A0TQpwN2tGcGo5cDYrbVh4c3B3WG1aQmVReXpoUUlEQVFBQk1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ0tpYlpXCldZZUVHdnMzTEM4NWU5VHJsbjNoWElvczh2QTNZS1pLNVV1Q3I5VmpNU2RpYThGdU5DcngvcHluS3g2NEtOVmMKazQvZFAwMm1NK0E0cHFvYUYzelhHczdhanovMDM2OG9SQTREZzRYayt3T0lVdkdKNkd1MHc3dkZOczlLRWJoUQo3WkFjRnFYWU4rd1ZaQ0IxeEtoUTRUZmZucCs3RVA3c0l5M1FXZjl3T2IwTVY4bmo5TjNWTktNWHljWFAvazJ4CndjajNXM0dNcitqS2RjbnYxRVFRVjhnREluVks1ODB0WnZ0Z3BFWksrbUpVN2pnUndSb0VzMHFiaFZuZTlHZm0KUGVwSVFwcTJIUGFuWThJcGUrcmtybk42RGFpR1VZdGVSZmQ1VHBWTzRJZ3BxT1VNTFNvbmtTUitPdFRGTFdPNgpuMHRxb1AzL3dad0J4N21pCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdi9Zb1UySnlPazVpaFdTbDlTM0ZZcjMwZG44TmxkSTBkcDdoZElLZWVCYjlmY09QCklLT1F3S3dSN0JybEl4MUlaanRtbE5lU0p3WjZydndXYXZORlNPYlB4cUdkMG5OZ3FFYlpGbU9nL2NIeDFJa3kKNGtPSGJvdXJnRVMxM3QxWE1NMVlBZjVSbVNRNE5Cb2VMQUdZVUFoaDM5aTFKdjlsbkdEV09KM2xoeS9HODR4MQovOExiK0NRRzdFQjdpcTZMa2RoOTh2emNMSGF2VkthYlp2SXgxclZ0dFVJTEtMQlcrcFN5eDdpZFZFYVZXM1ZGCldrbTZiWjF5NHpLREN4R3dtQ1h3SkRCY2JwUk1Yc2ZCYWFENWFJOHgraDk2MjJUZkRjUFQySktlUTIwdi9wQ1IKNERDbG85RnovUDRNcDdrRnBqOXA2K21YeHNwd1htWkJlUXl6aFFJREFRQUJBb0lCQUJCL0Z2Z1RmYjJFL3ZKMwpzOHRlSTVoWXVxbDBRYmFlV2VQWHc0Zy9zVjZnbXlnenBoa245VWlaZ1BESlh1ZWxuSk1zaDZSQzRreDRRaExICmx5V1p3bHFCZTFtV2lmbUw4TUtGVkNLWWJUMWhiV2JXWTRrT1JKVTdhNEdhWmdiQS9yMHk2RjFEZmIrclhTa2QKRlhxeXFHUTRWRERvYnFqclNkQW1na0piVDE1T2xwVXpadGZGWFZmZkpRdDRyd21vUzN6VVh1MTE4M1NlT0cyQQpZV1BUNkxhU2ZnV3F5cFdNaDZPdXo1VW9qNHFMbEVVaVorNFRZQk9lRjk3Ry9mUExDSkZTMnhPQisyNzNrbTlXCkFBYjIvb2hKa3BnTEZFVldhb29iWmJaV1oyVko0TnlhTzBtNlkrdy83cVB2bHVkR2JkbUpwMVJuQXJUWnVFcHkKQzdBTWlBRUNnWUVBN3Q0bkY4SDZPYnNzV1cyTjZqZC83cjBQUWlhQWZNdkFMVXl3Tnp4R3l3bVh1ZUt2VVBLQQpGK3dsWWhLWS9mZWVJdlNnUlRaNmtHUTB0Y2d6NkJaYjlFZDJzM2NtZjBpNkFyaUJWRElURUVRZGNuT1Q1ZTJKCmtwRUF4MThneDdMbThlcDNYOXhLUUlzcUFpWi8wMG9ydnFnVXJQUEJ6UGxGMjRCdkprSzZYNjhDZ1lFQXpickMKbzQwNmxVWGF1aHB2NkgzQ0E5NzViU3VKYS8wQUdNVmhXY3NuN0NTYlQ5QzN6bzlSMUNNN2g4ekEzUW40Z0MvNwpyZStvcythVlRyUEdCdFJOTEhzVENYcERYZFQ5SWhBUzBiZjJZMXRaUU9nYkJhTXdaVERiRHBQTms5bnJ4L2M3CkJMNk5EQkUweEpJMXV6dzM5QlhUYlE3R3ZlWm9XUXFXR2FtVm1Rc0NnWUFyUUtpOWdZOW93cjYrRnJ0YXpOL3EKZit0eVkveGlISmJZM1FrUGgyZWVQa2R1RG1FR2ZGSzdnalFtdFExazkyQjRIZW1qZnNEa3duQlU5a0tINVB5VAptQmtqV0JEdGZXTEpPVldaeEZOMVg1QWhlRkl3a1RtWEE1Q3JpVXNyUGZiWm1VWXlZblpEaDY5OG9qSUZOV29FClpQVVJlRFlBZ3FhbW4zUUE3cFpHMndLQmdRQ01NbXB6dEVtbzhncWxhbUM2eWdDT1RNUWpibGplMjNIV2I2UHcKNGk0WmtiUzVocDNMeVFWVmtKRC84VHU1SmhOUG4rTmVYQVRXWEJ1Qm42Y2lma2o5Ti8zNEpuYUVHaUpLdFROdAo4WFNacnVXN0FyRnZmUTc4MW5kaGpyMjR0UGdsdEVobTZrZ0tZaXRZamQ3SjhyYWF3c2pxOS9mZDc0ZEtycGt0CmNkQzlrd0tCZ1FDZHRoczI4MFNickxVR1RYZ21zSGRxS1JjYXVLN0VSRnl4MTFzbXRMVS9nbVU4bmZBY080bTAKV0llYW1OQ1FsejV0Ymx6cjRGdkthQmt6Q0Jsb3ZTTDZKRjd5TWhiWWhxQ1Z2bGV5ZDVnaEkzeFBFVmdiQ013dQprdWMrdGE4UjhsMVArb0dwVzlYM2hOdEhyUktucHlKckRlcUJkb29ialZ6eUp2d1hreTE0L3c9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
```
3. Alternatively, use the CLI to create the secret. You can reference the certificate and keypair files without encoding them in base64.
```
kubectl create secret tls ta-tls-ca-key-pair --key ./ta.key --cert ./ta.crt
```
4. In the migration bundle generated by TA, update the _host_ and _secretName_ attributes for the Ingress feature in the values.yaml file:
```
ingress:
  enabled: true
  rewriteTarget: "/"
  path: "/modresortswar/"
  host: "tademo.rtp.raleigh.ibm.com"
  secretName: "ta-tls-ca-key-pair "
```
The _secretName_ is the name of the secret created in Step 2/3. _host_ is the fully-qualified domain name that resolves to the IP address of your clusterâ€™s proxy node. The value for _host_ must also match the _commonName_ specified in the certificate and key pair.

5. Deploy the application using the updated migration bundle files


It is also possible to use the IBM Cloud Private cert-manager to issue and manage certificates. Detailed steps is described in this document:
https://www.ibm.com/support/knowledgecenter/en/SSBS6K_3.1.0/manage_applications/create_cert.html#adding_ingress

After a certificate is generated, you get a secret containing a certificate and a key, with a domain as commonName in the certificate. Here are further steps to swap TA's Ingress certificate, assuming you have TA installed with Ingress.

6. Add new return url to OIDC registration.

`curl -kv -X PUT -u oauthadmin:$OAUTH2_CLIENT_REGISTRATION_SECRET -H "Content-Type: application/json" --data @oidc-registration.json https://$MASTER_IP:9443/oidc/endpoint/OP/registration/$ur-client-id-defined-at-TA-installation | jq .`
Sample json file to be to sent:
 + In short, is to add `https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443` to each of the fields having the proxy IP.
 + 433 port is significant.
 + OAUTH2_CLIENT_REGISTRATION_SECRET can be get from: `kubectl get secret platform-oidc-credentials -o yaml -n kube-system`. The value of OAUTH2_CLIENT_REGISTRATION_SECRET is base64 encoded, thus, you need to decode: `base64 --decode <<< value`

```
{
  "token_endpoint_auth_method": "client_secret_basic",
  "client_id": "ur-client-id-defined-at-TA-installation",
  "client_secret": "ur-client-secret-defined-at-TA-installation",
  "scope": "openid profile email",
  "grant_types": [
    "authorization_code",
    "client_credentials",
    "password",
    "implicit",
    "refresh_token",
    "urn:ietf:params:oauth:grant-type:jwt-bearer"
  ],
  "response_types": [
    "code",
    "token",
    "id_token token"
  ],
  "application_type": "web",
  "subject_type": "public",
  "post_logout_redirect_uris": [
    "https://9.42.29.103:443/ken-test-9-ui/logout",
    "https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443/ken-test-9-ui/logout"
    "https://9.42.23.152:8443/console/logout",
    "https://mycluster.icp:8443/console/logout"
  ],
  "preauthorized_scope": "openid profile email general",
  "introspect_tokens": true,
  "trusted_uri_prefixes": [
   "https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443/",
    "https://9.42.29.103:443/",
    "http://localhost:3000/"
  ],
  "redirect_uris": [
    "https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443/ken-test-9-ui/icp/auth/callback",
    "https://9.42.29.103:443/ken-test-9-ui/icp/auth/callback"
  ]
}
```
7. Backup TA's Ingress yaml. You can run `kubectl get ingress ken-test-9-ibm-transadv-dev-ken-ingress -o yaml` , copy and paste the results to a text file. Note: indention is significant.
8. Delete the TA's Ingress yaml. [Read the note below before proceeding] `kubectl delete ingress ken-test-9-ibm-transadv-dev-ingress`.
  + **NOTE: you can try to edit the ingress without deleting it: `kubectl edit ingress ken-test-9-ibm-transadv-dev-ken-ingress` but my test environment's Ingress failed to swap certificate most of the time.**
9. If you deleted the Ingress, then update the ingress file, you backed up at step 2:
  + added `host` under `rules`
  + added `tls` under `spec`
  + the host value shall be the same as the `commonName` in the certificate stored in the secret. The example below, I have host value of `ta-dev-icp-proxy-1.rtp.raleigh.ibm.com` and from secrete `ken-tls-secret`
```
spec:
  rules:
  - host: ta-dev-icp-proxy-1.rtp.raleigh.ibm.com
    http:
      paths:
      - backend:
          serviceName: ken-test-9-ibm-transadv-dev-ken-ui
          servicePort: 3000
        path: /ken-test-9-ui
      - backend:
          serviceName: ken-test-9-ibm-transadv-dev-ken-server
          servicePort: 9080
        path: /ken-test-9-server
  tls:
  - hosts:
    - ta-dev-icp-proxy-1.rtp.raleigh.ibm.com
    secretName: ken-tls-secret
```
10. Save the ingress file and go to the file directory, and run. `kubectl apply -f /Users/ibm/Downloads/ken-igress.yaml`
  + the example I saved the file named `ken-igress.yaml`
  + I ran the command from directory `/Users/ibm/Downloads/`
11. Test the ingress: `kubectl get ingress`
  + if you see, `HOSTS ` with value of `*`, you need to add load balancer to the ingress.
```
NAME                                  HOSTS     ADDRESS       PORTS     AGE
ken-test-9-ibm-transadv-dev-ingress   *         9.42.29.103   80, 443   2m
```
12. Add load balancer. Run `kubectl edit ingress ken-test-9-ibm-transadv-dev-ken-ingress`, and
 + add/edit to the example below
 + 9.42.29.103 is the proxy IP
```
status:
  loadBalancer:
    ingress:
    - ip: 9.42.29.103
```
13. Save and exit, re-run: `kubectl get ingress`, you shall see the `HOSTS` now points to your domain:

```
NAME                                      HOSTS                                    ADDRESS       PORTS     AGE
ken-test-9-ibm-transadv-dev-ken-ingress   ta-dev-icp-proxy-1.rtp.raleigh.ibm.com   9.42.29.103   80, 443   56s
```

14. Test certificate on the Ingress itself: `curl -v -k --resolve ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443:9.42.29.103 https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com`
 + `ta-dev-icp-proxy-1.rtp.raleigh.ibm.com` is my domain pointing to `9.42.29.103`
 + In the output, you shall see ***  subject: CN=ta-dev-icp-proxy-1.rtp.raleigh.ibm.com; O=TA**

```
* Added ta-dev-icp-proxy-1.rtp.raleigh.ibm.com:443:9.42.29.103 to DNS cache
* Rebuilt URL to: https://ta-dev-icp-proxy-1.rtp.raleigh.ibm.com/
* Hostname ta-dev-icp-proxy-1.rtp.raleigh.ibm.com was found in DNS cache
*   Trying 9.42.29.103...
* TCP_NODELAY set
* Connected to ta-dev-icp-proxy-1.rtp.raleigh.ibm.com (9.42.29.103) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/cert.pem
  CApath: none
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Client hello (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS change cipher, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* ALPN, server accepted to use h2
* Server certificate:
*  subject: CN=ta-dev-icp-proxy-1.rtp.raleigh.ibm.com; O=TA
*  start date: Mar 19 15:51:20 2019 GMT
*  expire date: Mar 18 15:51:20 2020 GMT
*  issuer: CN=ta-dev-icp-proxy-1.rtp.raleigh.ibm.com; O=TA
*  SSL certificate verify result: self signed certificate (18), continuing anyway.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x7fb4f8806a00)
> GET / HTTP/2
> Host: ta-dev-icp-proxy-1.rtp.raleigh.ibm.com
> User-Agent: curl/7.54.0
> Accept: */*
> 
* Connection state changed (MAX_CONCURRENT_STREAMS updated)!
< HTTP/2 404 
< server: nginx/1.15.6
< date: Tue, 19 Mar 2019 16:07:23 GMT
< content-type: text/plain; charset=utf-8
< content-length: 21
< strict-transport-security: max-age=15724800; includeSubDomains
< 
* Connection #0 to host ta-dev-icp-proxy-1.rtp.raleigh.ibm.com left intact
```
15. You can also tested on UI app:
<img width="1020" alt="screenshot 2019-03-20 at 0 08 05" src="https://media.github.ibm.com/user/8257/files/e0eb7800-4aa8-11e9-9de9-917f6f01b6c8">
